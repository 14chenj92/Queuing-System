<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.8.0/dist/sweetalert2.min.css"
    />
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="styles.css" />
    <title>Badminton Registration & Booking</title>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
</script>
<script type="text/javascript">
   (function(){
      emailjs.init({
        publicKey: "mvTBtzs6TShj8eUpt",
      });
   })();
</script>
    <script>
      let users = {};

      function generatePassword() {
        const words = ["red", "blue", "green", "pink", "dog", "cat", "fox"];
        const password = words[Math.floor(Math.random() * words.length)];
        const username = document.getElementById("username").value;
        const firstName = document.getElementById("firstName").value;
        const lastName = document.getElementById("lastName").value;
        const email = document.getElementById("email").value;
        const code = document.getElementById("code").value;


        if (!username || !firstName || !lastName || !email) {
          Swal.fire({
            icon: "error",
            title: "Please fill out all fields.",
          });
          return;
        }

        fetch("/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, firstName, lastName, email }),
        })
        .then((response) => response.json())
    .then((data) => {
        const passwordDisplay = document.getElementById("password");
        if (data.message) {
            if (data.message === "User registered successfully") {
                passwordDisplay.textContent = "Generated Password: " + password;
                passwordDisplay.style.color = "green";
                passwordDisplay.style.fontSize = "24px";
            } else if (data.message === "Username already exists") {
                passwordDisplay.textContent =
                    "Username already exists. Please choose another username.";
                passwordDisplay.style.color = "red";
            } else if (data.message === "Email already exists") {
                passwordDisplay.textContent =
                    "Email already exists. Please choose another email.";
                passwordDisplay.style.color = "red";
            }
        }
          })
          .catch((err) => console.error("Error:", err));
      }

      function showUsers() {
        fetch("/users")
          .then((response) => response.json())
          .then((data) => {
            users = {}; // Clear previous data
            let userList = "<h3>Stored Usernames and Passwords</h3><ul>";
            data.forEach((user) => {
              users[user.username] = user.password; // Store data in the `users` object
              userList += `<li>${user.username}: ${user.password} ${user.firstName} ${user.lastName} ${user.email}</li>`;
            });
            userList += "</ul>";
            document.getElementById("userList").innerHTML = userList;
          })
          .catch((err) => console.error("Error fetching users:", err));
      }
      function showUsers() {
  fetch("/users")
    .then((response) => response.json())
    .then((data) => {
      users = {}; // Clear previous data
      let userList = "<h3>Stored Users</h3><ul>";
      data.forEach((user) => {
        users[user.username] = user.password; // Store data in the `users` object

        userList += `
          <li>
            <strong>Username:</strong> ${user.username} <br>
            <strong>Password:</strong> ${user.password} <br>
            <strong>First Name:</strong> ${user.firstName} <br>
            <strong>Last Name:</strong> ${user.lastName} <br>
            <strong>Email:</strong> ${user.email} <br>
            <strong>Approved:</strong> ${user.approved} <br>
            <button onclick="editUser('${user.username}')">Edit</button>
            <button onclick="deleteUser('${user.username}')">Delete</button>
          </li>
        `;
      });
      userList += "</ul>";
      document.getElementById("userList").innerHTML = userList;
    })
    .catch((err) => console.error("Error fetching users:", err));
}


function editUser(username) {
  let newPassword = prompt(`Enter new password for ${username}:`);
  if (newPassword) {
    fetch(`/users/${username}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ password: newPassword }),
    })
      .then((response) => response.json())
      .then(() => {
        alert(`Password updated for ${username}`);
        showUsers(); // Refresh the list
      })
      .catch((err) => console.error("Error updating user:", err));
  }
}

function deleteUser(username) {
  if (confirm(`Are you sure you want to delete ${username}?`)) {
    fetch(`/users/${username}`, {
      method: "DELETE",
    })
      .then((response) => response.json())
      .then(() => {
        alert(`${username} deleted`);
        showUsers(); // Refresh the list
      })
      .catch((err) => console.error("Error deleting user:", err));
  }
}


      function bookCourt() {
        const court = document.getElementById("courtSelection").value;
        let enteredPlayers = [];

        // Track all currently booked players
        const allBookedPlayers = Object.values(courts).flatMap(
          (court) => court.currentPlayers
        );

        for (let i = 1; i <= 4; i++) {
          const username = document.getElementById(`bookingUsername${i}`).value;
          const password = document.getElementById(`bookingPassword${i}`).value;

          if (username && password) {
            if (users[username] === password) {
              if (allBookedPlayers.includes(username)) {
                Swal.fire({
                  icon: "error",
                  title: `User ${username} is already booked on another court.`,
                });
                return;
              }
              enteredPlayers.push(username);
            } else {
              Swal.fire({
                icon: "error",
                title: `Wrong password for ${username}`,
              });
              return;
            }
          }
        }

        if (enteredPlayers.length !== 2 && enteredPlayers.length !== 4) {
          Swal.fire({
            icon: "error",
            title: "You can only book a court with 2 or 4 players.",
          });
          return;
        }

        if (courts[court].currentPlayers.length === 0) {
          courts[court].currentPlayers = enteredPlayers;
          courts[court].timeLeft = 20;
          startCountdown(court);
        } else {
          if (courts[court].queue.length < 5) {
            courts[court].queue.push(enteredPlayers);
          } else {
            alert("Queue is full. Maximum 5 groups allowed.");
            return;
          }
        }

        saveCourtData();
        clearBookingFields();
        renderCourts();
      }

      function saveCourtData() {
        fetch("/update-courts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(courts),
        });
      }

      // Load courts data from the server
      function loadCourtData() {
        fetch("/courts")
          .then((response) => response.json())
          .then((data) => {
            courts = data;

            Object.keys(courts).forEach((court) => {
              if (
                courts[court].currentPlayers.length > 0 &&
                courts[court].timeLeft > 0
              ) {
                startCountdown(court);
              }
            });

            renderCourts();
          })
          .catch((err) => console.error("Error fetching courts:", err));
      }

      window.onload = function () {
        loadCourtData();
      };

      function startCountdown(court) {
        let interval = setInterval(() => {
          if (courts[court].timeLeft > 0) {
            courts[court].timeLeft--;
            renderCourts();
          } else {
            clearInterval(interval);
            courts[court].currentPlayers = [];
            if (courts[court].queue.length > 0) {
              courts[court].currentPlayers = courts[court].queue.shift();
              courts[court].timeLeft = 20;
              startCountdown(court);
            }
            renderCourts();
          }
        }, 1000);
      }

      function clearBookingFields() {
        for (let i = 1; i <= 4; i++) {
          document.getElementById(`bookingUsername${i}`).value = "";
          document.getElementById(`bookingPassword${i}`).value = "";
        }
      }

      function renderCourts() {
        let courtDisplay = "";
        let courtCount = 1; // To track which court is being rendered
        for (const [court, details] of Object.entries(courts)) {
          let minutes = Math.floor(details.timeLeft / 60);
          let seconds = details.timeLeft % 60;

          // Determine court status: "Open" if no current players, "Closed" if booked and timer running
          let courtStatusClass =
            details.currentPlayers.length === 0 ? "open" : "closed";

          courtDisplay += `<div class="court-card ${courtStatusClass}">`;
          courtDisplay += `<h3>${court}</h3>`;
          courtDisplay += `<p class="status">${
            details.currentPlayers.length === 0 ? "Open" : "Closed"
          }</p>`;

          // If the court is closed, show the remaining time
          if (courtStatusClass === "closed") {
            courtDisplay += `<p>Time Left: ${minutes}:${seconds
              .toString()
              .padStart(2, "0")}</p>`;
          }

          courtDisplay += `<p>Current Players: ${
            details.currentPlayers.join(", ") || "None"
          }</p>`;
          for (let i = 0; i < 5; i++) {
            courtDisplay += `<p>Queue ${i + 1}: ${
              details.queue[i] ? details.queue[i].join(", ") : "Empty"
            }</p>`;
          }

          courtDisplay += `</div>`;

          // Break after the 5th court to start a new row (second row will have 4 courts)
          if (courtCount === 5) {
            courtDisplay += "<div style='flex-basis: 100%;'></div>"; // force a new row
          }

          courtCount++;
        }
        document.getElementById("courtStatus").innerHTML = courtDisplay;
      }
    </script>
  </head>
  <body>
    <h2>Badminton Registration</h2>
    <label for="username">Create Your Username:</label>
    <input type="text" id="username" name="username" required />
    <br /><br />
    <label for="firstName">First Name:</label>
<input type="text" id="firstName" name="firstName" required />

<br /><br />

<label for="lastName">Last Name:</label>
<input type="text" id="lastName" name="lastName" required />

<br /><br />
<form id="emailForm">
  <label for="email">Email:</label>
  <input type="email" id="email" name="email" required /><br><br>
  <button type="submit">Send Email</button>
</form>
<br /><br />

<form id="verifyForm">
    <label for="code">Enter Verification Code:</label>
    <input type="text" id="code" name="code" required />
    <button type="submit">Verify</button>
</form>

<p id="message"></p>

    <button onclick="generatePassword()">Create User</button>
    <br /><br />
    <p id="password" style="font-weight: bold"></p>
    <br />
    <button onclick="showUsers()">Show All Users</button>
    <div id="userList"></div>
    <!-- <div id="court-list">
      <ul>
          <li>
              Player 1 
              <button onclick="removePlayer(1)">Remove</button>
          </li>
          <li>
              Player 2 
              <button onclick="removePlayer(2)">Remove</button>
          </li>
      </ul>
  </div> -->

    <h2>Badminton Court Booking</h2>
    <label>Select Court:</label>
    <select id="courtSelection">
      <option value="Court 1">Court 1</option>
      <option value="Court 2">Court 2</option>
      <option value="Court 3">Court 3</option>
      <option value="Court 4">Court 4</option>
      <option value="Court 5">Court 5</option>
      <option value="Court 6">Court 6</option>
      <option value="Court 7">Court 7</option>
      <option value="Court 8">Court 8</option>
      <option value="Court 9">Court 9</option>
    </select>
    <br /><br />
    <h3>Enter Player Details</h3>
    <div>
      <label>Player 1:</label>
      <input type="text" id="bookingUsername1" placeholder="Username" />
      <input type="password" id="bookingPassword1" placeholder="Password" />
    </div>
    <div>
      <label>Player 2:</label>
      <input type="text" id="bookingUsername2" placeholder="Username" />
      <input type="password" id="bookingPassword2" placeholder="Password" />
    </div>
    <div>
      <label>Player 3:</label>
      <input type="text" id="bookingUsername3" placeholder="Username" />
      <input type="password" id="bookingPassword3" placeholder="Password" />
    </div>
    <div>
      <label>Player 4:</label>
      <input type="text" id="bookingUsername4" placeholder="Username" />
      <input type="password" id="bookingPassword4" placeholder="Password" />
    </div>

    <br />
    <button onclick="bookCourt()">Book Court</button>

    <h2>Court Status</h2>
    <div id="courtStatus" class="court-container"></div>
    <script>
    //   renderCourts();
    //   async function removePlayer(playerId) {
    //     const response = await fetch(`/remove-player/${playerId}`, {
    //         method: 'DELETE'
    //     });

    //     if (response.ok) {
    //         alert('Player removed successfully!');
    //         location.reload(); // Refresh the court list
    //     } else {
    //         alert('Failed to remove player.');
    //     }
    // }
    </script>
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.8.0/dist/sweetalert2.all.min.js"></script>
  </body>
</html>
